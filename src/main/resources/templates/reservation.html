<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">

    <title>会議室予約</title>
	<link rel="stylesheet" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}">
	<link rel="stylesheet" th:href="@{/custom.css}">
	<!-- <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script> -->
	<script th:src="@{/webjars/jquery/jquery.min.js}" defer></script>
	<script th:src="@{/webjars/bootstrap/js/bootstrap.min.js}" defer></script>
	<meta name="_csrf" th:content="${_csrf.token}"><!-- CSRFエラー対策 -->
	<meta name="_csrf_header" th:content="${_csrf.headerName}"><!-- CSRFエラー対策 -->

</head>
<body>
	<div class="content">


	<div class="container mt-4">
	    <div class="d-flex justify-content-between align-items-center mb-3">
	        <h2>会議室予約画面</h2>
	        <div>
	            <span th:text="${userName}" class="mr-3"></span>
	            <form th:action="@{/logout}" method="post" style="display:inline;">
	                <button type="submit" class="btn btn-secondary btn-sm">ログアウト</button>
	            </form>
	        </div>
	    </div>

	    <div class="text-center mb-3">
	        <a th:href="@{/reservation(date=${previousDate})}" class="btn btn-primary">前日</a>
	        <h3 class="d-inline-block mx-3" th:text="${displayDate}">YYYY/MM/DD</h3>
	        <a th:href="@{/reservation(date=${nextDate})}" class="btn btn-primary">翌日</a>
	    </div>
		
		
		<!-- <form id="reservationForm"　method="post" th:action="@{/reservation/process}">
		    <input type="hidden" name="reservations[1][1]" value="false" />
		    <input type="checkbox" name="reservations[1][1]" value="true" />
		    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
		    <button type="submit">送信</button>
		</form id="reservationForm"> -->
		
		
		<div th:if="${successMessage}" class="alert alert-success" role="alert">
		    <p th:text="${successMessage}"></p>
		</div>

		<div th:if="${errorMessage}" class="alert alert-danger" role="alert">
		    <p th:text="#{${errorMessage}}"></p>
		</div>
		

	<form id="reservationForm" th:action="@{/reservation/process}" method="post">
		<input type="hidden" name="date" th:value="${displayDateRaw}" /><!-- POST送信時に date パラメータがコントローラーの @RequestParam("date") に渡される -->
		<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
		<table class="table table-bordered text-center"><!-- 行（<tr>）が会議室名、列（<td>）が時間帯 -->
		        <thead>
		            <tr>
		                <th>会議室名</th>
		                <th th:each="time : ${timeList}" th:text="${time.timeName}">HH:MM ~ HH:MM</th>
		            </tr>
		        </thead>
		        <tbody><!--  falseは削除情報の送信に必要　#lists.any()の内部でネストされたループを実行するよりも、事前に変換されたSetやListに対するcontains()チェックの方が一般的に高速-->
		            <tr th:each="room : ${roomList}">
						<td th:text="${room.roomName}">会議室名</td>
						<th:block th:each="time : ${timeList}">
							<td>
								<input type="checkbox"
								       th:id="${'res_' + room.id + '_' + time.id}"
								       th:name="${'reservations[' + room.id + '][' + time.id + ']'}"
								       value="true"
								       th:checked="${reservedKeys.contains(room.id + '_' + time.id)}" 
									   th:disabled="${(reservedKeys.contains(room.id + '_' + time.id) and !myReservedKeys.contains(room.id + '_' + time.id))  or T(java.time.LocalDateTime).of(internalDate, T(java.time.LocalTime).of(T(java.lang.Integer).parseInt(time.timeName.replace('時', '')), 0)).isBefore(currentDateTime)}"  />

								<input th:if="not ${reservedKeys.contains(room.id + '_' + time.id)}"
								       type="hidden"
								       th:name="${'reservations[' + room.id + '][' + time.id + ']'}"
								       value="false" />
							</td>
						</th:block>
		            </tr>
		        </tbody>
		    </table>

			<div class="d-flex justify-content-end mt-3">
			     <button type="submit" class="btn btn-primary">予約・解除</button>
			</div>
	</form>

		
	</div><!-- <div class="container mt-4"> -->
	
	
	</div><!-- <div class="content"> -->
<script th:src="@{/reservation.js}"></script>
<!--<input type="checkbox" name="reservation"> 仮表示用 	
	<input type="checkbox"
			th:name="${'reservations[' + room.id + '][' + time.id + ']'}"
			value="true"
			th:checked="${#lists.any(reservedList, r -> r.getRoomId().equals(room.id) and r.getTimeId().equals(time.id))}">
			th:checked="${#lists.any(reservedList, r -> r.roomId.equals(room.id) and r.timeId.equals(time.id))}">
			th:checked="${room.id != null and time.id != null and #lists.any(reservedList, r -> r.roomId.equals(room.id) and r.timeId.equals(time.id))}">
			th:checked="${room.id != null and time.id != null  and reservedList != null and #lists.any(reservedList, r -> r.roomId.equals(room.id) and r.timeId.equals(time.id))}">
			thymeleafのバージョンによってはラムダ式が使えない
			<td th:each="time : ${timeList}">
			    <input type="checkbox"
			           th:name="${'reservations[' + room.id + '][' + time.id + ']'}"
			           value="true"
			           th:checked="${false}">

			    <span th:each="reserved : ${reservedList}">
			        <th:block th:if="${reserved.roomId == room.id and reserved.timeId == time.id}">
			            <input type="checkbox"
			                   th:name="${'reservations[' + room.id + '][' + time.id + ']'}"
			                   value="true"
			                   th:checked="${true}">
			        </th:block>
			    </span>
			</td>
			以下のようにすると、チェック状態がテンプレートで制御されているため、ユーザー操作が反映されない
			<input type="checkbox"
						th:name="${'reservations[' + room.id + '][' + time.id + ']'}"
						value="true"
						th:checked="${reservedKeys.contains(room.id + '_' + time.id)}">
						<input type="checkbox"
						       th:id="${'res_' + room.id + '_' + time.id}"
						       th:name="${'reservations[' + room.id + '][' + time.id + ']'}"
						       value="true"
						       th:checked="${reservedKeys.contains(room.id + '_' + time.id)}" 
							   th:disabled="${(reservedKeys.contains(room.id + '_' + time.id) and !myReservedKeys.contains(room.id + '_' + time.id))  or internalDate.isBefore(T(java.time.LocalDate).now())}"  />
			
-->

	<!-- もしリストが空でなければ、このチェックボックスをチェック状態にする  -->
</body>
</html>